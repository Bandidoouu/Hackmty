<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Usuario</title>
  <link rel="stylesheet" href="/_static/style.css">
</head>
<body>
  <div class="caja user-page" id="user-box">
    <h1>Usuario</h1>
    <div class="user-grid">
      <div class="user-left">
        <div id="user-info">Cargando...</div>
        <div id="balance-area" style="margin-top:1rem;">Balance: cargando...</div>

          <div id="left-msg" class="msg" style="display:none; margin-top:8px"></div>
          <div id="portfolio-summary" style="margin-top:12px; width:100%; text-align:left">
            <h4>Resumen</h4>
            <div id="portfolio-usd">USD disponible: —</div>
            <div id="portfolio-positions" style="margin-top:8px">Posiciones: —</div>
          </div>

          <div id="user-actions" style="margin-top:1rem; width:100%"></div>

        <div style="margin-top:1rem;">
          <button id="logout-btn" class="comenzar-btn">Cerrar sesión</button>
        </div>
      </div>

      <div class="user-right">
        <div id="tx-area" style="margin-top:0; width:100%">
          <h3>Historial</h3>
          <div id="tx-msg" class="msg" style="display:none"></div>
          <div class="tx-scroll"><table id="tx-table" class="tx-table" style="width:100%; border-collapse:collapse; background:#fff"></table></div>
        </div>

        <div style="margin-top:1rem;">
          <h3>Transferir</h3>
          <label>Destino (account id)</label>
          <input id="to-account" placeholder="LOCALACC-..." style="width:100%" />
          <label style="margin-top:8px;display:block">Monto USD</label>
          <input id="transfer-amount" type="number" step="0.01" style="width:100%" />
          <div style="margin-top:8px;text-align:right"><button id="transfer-btn" class="comenzar-btn">Enviar</button></div>
        </div>
        
        <!-- Tools panel: Gemini / Nessie quick tools -->
        <div class="tools-panel" style="margin-top:2rem;">
          <h3>Herramientas</h3>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label>Symbol</label>
              <input id="tool-sym" value="BTCUSD" style="width:100%" />
            </div>
            <div style="width:150px">
              <label>Monto USD</label>
              <input id="tool-amt" type="number" value="50" step="0.01" style="width:100%" />
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="tool-price-btn" class="small-btn">Consultar precio</button>
              <button id="tool-buy" class="small-btn">Buy</button>
              <button id="tool-sell" class="small-btn">Sell</button>
            </div>
          </div>
          <div id="tool-price" style="margin-top:8px;color:#234a57;font-weight:600">Precio: —</div>
          <div id="tool-msg" class="msg" style="display:none;margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  async function loadMe(){
    const token = localStorage.getItem('access_token');
    if(!token){ location.href = '/_static/login.html'; return; }
    try{
      const res = await fetch('/auth/me', { headers: { 'Authorization': 'Bearer '+token } });
      if(!res.ok){ localStorage.removeItem('access_token'); location.href='/_static/login.html'; return; }
      const data = await res.json();
      document.getElementById('user-info').innerHTML = `
        <p><strong>Email:</strong> ${data.email}</p>
        <p><strong>Nombre:</strong> ${data.first_name || '-'} ${data.last_name || ''}</p>
        <p><strong>Nessie cust id:</strong> ${data.nessie_customer_id || '-'}</p>
      `;
      // fetch balance
      try{
        const b = await fetch('/nessie/balance', { headers: { 'Authorization': 'Bearer '+token } });
        if(b.ok){
          const jb = await b.json();
          document.getElementById('balance-area').textContent = `Balance: $${jb.balance.toFixed(2)} (acct: ${jb.account_id})`;
          // update portfolio USD immediately
          document.getElementById('portfolio-usd').textContent = `USD disponible: $${jb.balance.toFixed(2)}`;
          // load transactions once we have account id
          loadTransactions();
        }else{
          document.getElementById('balance-area').textContent = 'Balance: Error';
        }
      }catch(e){ console.error(e); document.getElementById('balance-area').textContent = 'Balance: Error'; }
    }catch(err){
      console.error(err);
      localStorage.removeItem('access_token');
      location.href = '/_static/login.html';
    }
  }
  
  document.getElementById('transfer-btn').addEventListener('click', async ()=>{
    const token = localStorage.getItem('access_token');
    const to = document.getElementById('to-account').value.trim();
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const txMsg = document.getElementById('tx-msg');
    txMsg.style.display = 'none';
    if(!to || !amount || amount<=0){ txMsg.textContent = 'Rellena destino y monto válido'; txMsg.style.display='block'; return; }
    try{
      const res = await fetch('/nessie/transfer', { method: 'POST', headers: { 'Authorization': 'Bearer '+token, 'Content-Type':'application/json'}, body: JSON.stringify({ to_account_id: to, amount, description: 'User transfer' }) });
      if(!res.ok){ const t = await res.text(); txMsg.textContent = 'Transfer failed: '+t; txMsg.style.display='block'; return; }
      txMsg.textContent = 'Transferencia enviada'; txMsg.style.display='block';
      // refresh balance & txs
      await loadMe();
    }catch(e){ console.error(e); txMsg.textContent = 'Transfer error'; txMsg.style.display='block'; }
  });
  document.getElementById('logout-btn').addEventListener('click', ()=>{ localStorage.removeItem('access_token'); location.href='/_static/login.html'; });
  loadMe();

  async function loadTransactions(){
    const token = localStorage.getItem('access_token');
    const tbl = document.getElementById('tx-table');
    tbl.innerHTML = '<tr><td>Loading...</td></tr>';
    try{
      const r = await fetch('/nessie/transactions?limit=50', { headers: { 'Authorization': 'Bearer '+token } });
      if(!r.ok){ tbl.innerHTML = '<tr><td>Error cargando transacciones</td></tr>'; return; }
      const j = await r.json();
      if(!j.transactions || j.transactions.length===0){ tbl.innerHTML = '<tr><td>No hay transacciones</td></tr>'; return; }
      const rows = j.transactions.map(t => `<tr><td>${new Date(t.created_at).toLocaleString()}</td><td>${t.description}</td><td style="text-align:right">${t.amount.toFixed(2)}</td></tr>`).join('');
      tbl.innerHTML = '<thead><tr><th>Fecha</th><th>Descripción</th><th>Importe (USD)</th></tr></thead><tbody>'+rows+'</tbody>';
      // compute positions from descriptions (simple parse of gemini trade descriptions)
      computeAndShowPositions(j.transactions);
    }catch(e){ console.error(e); tbl.innerHTML = '<tr><td>Error cargando transacciones</td></tr>'; }
  }

  function setLeftMsg(text, ok=true){
    const el = document.getElementById('left-msg');
    el.style.display = 'block';
    el.style.color = ok ? '#1B4079' : 'crimson';
    el.textContent = text;
    setTimeout(()=>{ el.style.display = 'none'; }, 5000);
  }

  async function computeAndShowPositions(transactions){
    // parse descriptions like "Buy BTCUSD 0.0008333" or "Sell BTCUSD 0.0005"
    const map = {};
    for(const t of transactions){
      const m = String(t.description).match(/(Buy|Sell)\s+([A-Z0-9]+)\s+([0-9\.]+)/i);
      if(m){
        const side = m[1].toLowerCase();
        const symbol = m[2].toUpperCase();
        const qty = parseFloat(m[3]);
        if(!map[symbol]) map[symbol] = 0;
        map[symbol] += (side === 'buy' ? qty : -qty);
      }
    }
    const posDiv = document.getElementById('portfolio-positions');
    if(Object.keys(map).length === 0){ posDiv.innerHTML = 'Posiciones: —'; return; }
    // for each symbol, get price from /gemini/price and show estimated USD value
    const lines = [];
    for(const sym of Object.keys(map)){
      try{
        const r = await fetch('/gemini/price?symbol='+encodeURIComponent(sym));
        if(!r.ok){ lines.push(`${sym}: ${map[sym].toFixed(8)} (precio desconocido)`); continue; }
        const j = await r.json();
        const val = Math.abs(map[sym]) * (j.price || 0);
        lines.push(`${sym}: ${map[sym].toFixed(8)} (~$${val.toFixed(2)})`);
      }catch(e){ lines.push(`${sym}: ${map[sym].toFixed(8)} (error precio)`); }
    }
    posDiv.innerHTML = 'Posiciones:<br>' + lines.join('<br>');
  }

  // --- Tools: price + trade on same page (calls /gemini/price and /gemini/trade)
  const toolPriceEl = () => document.getElementById('tool-price');
  const toolMsgEl = () => document.getElementById('tool-msg');

  async function fetchToolPrice(){
    const s = document.getElementById('tool-sym').value || 'BTCUSD';
    try{
      toolPriceEl().textContent = 'Precio: cargando...';
      const r = await fetch('/gemini/price?symbol='+encodeURIComponent(s));
      if(!r.ok){ toolPriceEl().textContent = 'Precio: error'; return null; }
      const j = await r.json();
      toolPriceEl().textContent = `Precio ${j.symbol}: $${j.price}`;
      return j;
    }catch(e){ toolPriceEl().textContent = 'Precio: error'; return null; }
  }

  async function doToolTrade(side){
    const sym = document.getElementById('tool-sym').value || 'BTCUSD';
    const amount_usd = parseFloat(document.getElementById('tool-amt').value || '0');
    const token = localStorage.getItem('access_token');
    const msg = toolMsgEl();
    msg.style.display = 'block'; msg.style.color = '#1B4079'; msg.textContent = 'Procesando...';
    try{
      const r = await fetch('/gemini/trade', { method: 'POST', headers: { 'Authorization':'Bearer '+token, 'Content-Type':'application/json'}, body: JSON.stringify({ symbol: sym, side, amount_usd }) });
      if(!r.ok){ const t = await r.text(); msg.style.color='crimson'; msg.textContent = 'Trade failed: '+t; return; }
      const j = await r.json(); msg.style.color='#1B4079'; msg.textContent = 'Trade ejecutado: '+ JSON.stringify(j);
      // refresh balance & transactions to reflect trade
      await loadMe();
    }catch(e){ msg.style.color='crimson'; msg.textContent = 'Error trade'; }
  }

  // wire tool buttons
  document.addEventListener('click', function(e){
    if(e.target && e.target.id === 'tool-price-btn'){ fetchToolPrice(); }
    if(e.target && e.target.id === 'tool-buy'){ doToolTrade('buy'); }
    if(e.target && e.target.id === 'tool-sell'){ doToolTrade('sell'); }
  });

  // --- Additional user actions: bootstrap account, simulate paycheck, refresh ---
  async function bootstrapAccount(){
    const token = localStorage.getItem('access_token');
    try{
      const btn = event?.target; if(btn) btn.disabled = true;
      setLeftMsg('Inicializando cuenta...', true);
      const r = await fetch('/auth/nessie/bootstrap', { method: 'POST', headers: { 'Authorization': 'Bearer '+token } });
      if(!r.ok){ const t = await r.text(); setLeftMsg('Bootstrap failed: '+t, false); if(btn) btn.disabled = false; return; }
      const j = await r.json();
      setLeftMsg('Cuenta inicializada: '+ j.account_id, true);
      await loadMe();
      if(btn) btn.disabled = false;
    }catch(e){ console.error(e); setLeftMsg('Error bootstrap', false); }
  }

  async function simulatePaycheck(amount){
    const token = localStorage.getItem('access_token');
    try{
      setLeftMsg('Simulando nómina...', true);
      const r = await fetch('/nessie/simulate-paycheck', { method: 'POST', headers: { 'Authorization': 'Bearer '+token, 'Content-Type':'application/json'}, body: JSON.stringify({ amount }) });
      if(!r.ok){ const t = await r.text(); setLeftMsg('Depósito failed: '+t, false); return; }
      const j = await r.json();
      setLeftMsg('Depósito simulado OK', true);
      await loadMe();
    }catch(e){ console.error(e); setLeftMsg('Error depósito', false); }
  }

  // add small UI controls (insert after page load)
  (function addControls(){
    const box = document.getElementById('user-box');
    const wrap = document.createElement('div');
    wrap.style.marginTop = '1rem';
    wrap.style.display = 'flex';
    wrap.style.gap = '8px';
    wrap.style.flexWrap = 'wrap';

    const boostBtn = document.createElement('button');
    boostBtn.textContent = 'Inicializar cuenta';
    boostBtn.className = 'comenzar-btn';
    boostBtn.style.fontSize = '1rem';
    boostBtn.addEventListener('click', ()=> bootstrapAccount());

    const payInput = document.createElement('input');
    payInput.type = 'number'; payInput.step = '0.01'; payInput.placeholder = 'Monto nómina USD';
    payInput.style.padding = '8px'; payInput.style.minWidth = '160px';

    const payBtn = document.createElement('button');
    payBtn.textContent = 'Simular nómina';
    payBtn.className = 'comenzar-btn';
    payBtn.style.fontSize = '1rem';
    payBtn.addEventListener('click', ()=>{ const v = parseFloat(payInput.value || '0'); if(!v || v<=0){ alert('Introduce monto válido'); return; } simulatePaycheck(v); });

    const refBtn = document.createElement('button');
    refBtn.textContent = 'Refrescar';
    refBtn.className = 'comenzar-btn';
    refBtn.style.fontSize = '1rem';
    refBtn.addEventListener('click', ()=> loadMe());

  wrap.appendChild(boostBtn);
  wrap.appendChild(payInput);
  wrap.appendChild(payBtn);
  wrap.appendChild(refBtn);
  const target = document.getElementById('user-actions');
  if(target) target.appendChild(wrap);
  })();
  </script>
</body>
</html>
